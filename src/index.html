<!doctype html>
<html lang="en"><head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="../uibuilder/images/node-blue.ico">

    <title>Blank template - Node-RED UIBUILDER</title>
    <meta name="description" content="Node-RED UIBUILDER - Blank template">

    <!-- Your own CSS (defaults to loading uibuilders css) -->
    <link type="text/css" rel="stylesheet" href="./index.css" media="all">

    <!-- UIBUILDER Core -->
    <script defer src="../uibuilder/uibuilder.iife.min.js"></script>

</head><body>
    <h1>Create AND/OR Flow</h1>

    <!-- Controls -->
    <button onclick="addInject()">Add Inject</button>
    <button onclick="addGate()">Add Gate</button>
    <button onclick="addDebug()">Add Debug</button>
    
    <h2>Connect Nodes</h2>
    <div>
        <select id="fromNode"></select> →
        <select id="toNode"></select>
        <button onclick="addConnectionFromDropdown()">Add Connection</button>
    </div>

    <!-- Nodes Preview -->
    <h2>Nodes</h2>
    <ul id="nodesList"></ul>

    <!-- Connections Preview -->
    <h2>Connections</h2>
    <ul id="connectionsList"></ul>

    <!-- JSON Preview -->
    <h2>Flow JSON Preview</h2>
    <pre id="jsonPreview" style="background:#eee;padding:1em;"></pre>

    <!-- Clear options -->
    <button onclick="clearPreview()">Clear JSON Preview</button>
    <button onclick="clearAll()">Clear All Nodes & Connections</button>
    
    <br>
    <br>
    <br>

    <!-- Send -->
    <button onclick="sendConfig()">Generate Flow</button>
    <p id="status"></p>

    <div id="configPanel"
        style="display:none; position:fixed; top:10%; left:10%; background:white; border:1px solid black; padding:1em; z-index:1000">
        <h3>Configure Gate Rules</h3>
        <p id="configLabel"></p>
        <div id="ruleForm"></div>
        <button onclick="addRuleRow()">Add Rule</button>
        <button onclick="saveConfig()">Save</button>
        <button onclick="closeConfigPanel()">Cancel</button>
    </div>

    <!-- uibuilder init -->
    <script src="./uibuilderfe.min.js"></script>
    <script>
    uibuilder.start();

    uibuilder.onChange('msg', msg => {
        document.getElementById('status').innerText = msg.payload;
    });
    </script>

    <!-- Logic -->
    <script>
    let nodes = [], connections = [];

    function addInject() {
    const label = 'Inject_' + (nodes.filter(n => n.type === 'inject').length + 1);
    const payload = confirm("Payload TRUE? Click OK for true, Cancel for false.") ? true : false;
    nodes.push({ type: 'inject', payload, label });
    render();
    }

    function addGate() {
        const label = 'Gate_' + (nodes.filter(n => n.type === 'gate').length + 1);
        const gateType = prompt("Gate type: and / or", "and");
        const inputs = [];
        nodes.push({ type: 'gate', gateType, inputs, label });
        render();
    }

    function addDebug() {
        const label = 'Debug_' + (nodes.filter(n => n.type === 'debug').length + 1);
        const inputs = [];
        nodes.push({ type: 'debug', inputs, label });
        render();
    }


    function clearPreview() {
    document.getElementById('jsonPreview').innerText = '';
    }

    function clearAll() {
        if (confirm("Are you sure you want to clear all nodes and connections?")) {
            nodes = [];
            connections = [];
            render();
            clearPreview();
        }
    }


    function addConnectionFromDropdown() {
        const from = document.getElementById('fromNode').value;
        const to = document.getElementById('toNode').value;
        if (!from || !to || from === to) return;
        connections.push({ from, to });
        render();
    }


    function render() {
        // Render nodes
        const ul = document.getElementById('nodesList');
        ul.innerHTML = '';
        nodes.forEach(n => {
            const li = document.createElement('li');
            const extra = n.gateType ? `(${n.gateType.toUpperCase()})` :
                n.payload !== undefined ? `payload=${n.payload}` : '';
            li.innerHTML = `${n.label} - ${n.type} ${extra}`;

            // Show rule count if gate
            if (n.type === 'gate' && Array.isArray(n.rules)) {
                li.innerHTML += ` [${n.rules.length} rule${n.rules.length > 1 ? 's' : ''}]`;
            }

            if (n.type === 'gate') {
                const btn = document.createElement('button');
                btn.innerText = 'Configure';
                btn.onclick = () => openConfigPanel(n.label);
                li.appendChild(btn);
            }

            ul.appendChild(li);
        });

        const selFrom = document.getElementById('fromNode');
        const selTo = document.getElementById('toNode');
        [selFrom, selTo].forEach(sel => {
                sel.innerHTML = '';
                nodes.forEach(n => {
                const opt = document.createElement('option');
                opt.value = n.label;
                opt.text = n.label;
                sel.appendChild(opt);
            });
        });

        // Render connections
        const cl = document.getElementById('connectionsList');
        cl.innerHTML = '';
        connections.forEach((c, i) => {
            const li = document.createElement('li');
            li.innerText = `${c.from} → ${c.to}`;
            cl.appendChild(li);
        });

        // Render JSON preview
        document.getElementById('jsonPreview').innerText = JSON.stringify({ nodes, connections }, null, 2);
        }

        function sendConfig() {
            uibuilder.send({ nodes, connections });
        }

        let currentGate = null;
        
        function openConfigPanel(label) {
            currentGate = nodes.find(n => n.label === label && n.type === 'gate');
            if (!currentGate) return;
            
            document.getElementById('configLabel').innerText = `Configuring ${label}`;
            document.getElementById('ruleForm').innerHTML = '';
            
            (currentGate.rules || []).forEach(rule => addRuleRow(rule));
            
            document.getElementById('configPanel').style.display = 'block';
        }
        
        function addRuleRow(rule = {}) {
            const form = document.getElementById('ruleForm');
            const div = document.createElement('div');

            div.innerHTML = `
                <input class="prop" placeholder="property" value="${rule.property || ''}">
                <select class="t">
                    <option value="eq"${rule.t === 'eq' ? ' selected' : ''}>eq</option>
                    <option value="lt"${rule.t === 'lt' ? ' selected' : ''}>lt</option>
                    <option value="lte"${rule.t === 'lte' ? ' selected' : ''}>lte</option>
                    <option value="gt"${rule.t === 'gt' ? ' selected' : ''}>gt</option>
                    <option value="gte"${rule.t === 'gte' ? ' selected' : ''}>gte</option>
                    <option value="neq"${rule.t === 'neq' ? ' selected' : ''}>neq</option>
                </select>
                <input class="val" placeholder="value" value="${rule.v || ''}">
                <select class="vt">
                    <option value="str"${rule.vt === 'str' ? ' selected' : ''}>str</option>
                    <option value="num"${rule.vt === 'num' ? ' selected' : ''}>num</option>
                    <option value="bool"${rule.vt === 'bool' ? ' selected' : ''}>bool</option>
                    <option value="prev"${rule.vt === 'prev' ? ' selected' : ''}>prev</option>
                </select>
            `;

            form.appendChild(div);

            const propInput = div.querySelector('.prop');
            const valInput = div.querySelector('.val');
            const vtSelect = div.querySelector('.vt');

            function handlePrevMode() {
                if (vtSelect.value === 'prev') {
                    propInput.value = 'payload';
                    propInput.disabled = true;

                    valInput.value = '';
                    valInput.disabled = true;
                } else {
                    propInput.disabled = false;
                    valInput.disabled = false;
                }
            }

            vtSelect.addEventListener('change', handlePrevMode);

            // Trigger on init
            handlePrevMode();
        }
        
        function saveConfig() {
            if (!currentGate) return;
            
            const form = document.getElementById('ruleForm');
            const rules = [];
            
            Array.from(form.children).forEach(div => {
                const [propertyInput, tSelect, valueInput, vtSelect] = div.querySelectorAll('input, select');
                rules.push({
                    property: propertyInput.value,
                    propertyType: "flow", // fixed for now
                    t: tSelect.value,
                    v: valueInput.value,
                    vt: vtSelect.value
                });
            });
            
            currentGate.rules = rules;
            closeConfigPanel();
            render();
        }
        
        function closeConfigPanel() {
            document.getElementById('configPanel').style.display = 'none';
            currentGate = null;
        }

    </script>
</body></html>
