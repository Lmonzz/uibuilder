<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Corrected path to match the uibuilder URL -->
    <link rel="icon" href="/test/images/node-blue.ico">

    <title>Blank template - Node-RED UIBUILDER</title>
    <meta name="description" content="Node-RED UIBUILDER - Blank template">

    <!-- Your own CSS -->
    <link type="text/css" rel="stylesheet" href="./index.css" media="all">

    <!-- UIBUILDER Core - Paths now match the uibuilder URL -->
    <script defer src="/test/uibuilder.iife.min.js"></script>
</head>

<body>
    <!-- ─── TRIGGER/EVENT SECTION ───────────────────────────── -->
    <h1>Event Trigger</h1>
    <div id="triggerSection" style="margin-bottom:2em; border:1px solid #ccc; padding:1em;">
        <div class="trigger-grid">
            <div class="trigger-label">
                <label for="triggerName"><b>Trigger Name:</b> <span style="color:red">*</span></label>
            </div>
            <div class="trigger-input">
                <input id="triggerName" type="text" placeholder="e.g. Receive Alert" required>
            </div>

            <div class="trigger-label">
                <label for="triggerDesc"><b>Description:</b></label>
            </div>
            <div class="trigger-input">
                <input id="triggerDesc" type="text" placeholder="Describe this trigger...">
            </div>

            <div class="trigger-label">
                <label for="triggerWhen"><b>When:</b></label>
            </div>
            <div class="trigger-input">
                <select id="triggerWhen">
                    <option value="">-- Select trigger --</option>
                    <option value="receive_alert">Receive alert</option>
                    <!-- Add more options here as needed -->
                </select>
            </div>
        </div>
    </div>
    <!-- ─────────────────────────────────────────────────────── -->


    <h1>Create Condition(s)</h1>
    <div id="conditionSection" style="margin-bottom:2em; border:1px solid #ccc; padding:1em;">
        <!-- Controls -->
        <button id="addInjectBtn">Add Inject</button>
        <button id="addGateBtn">Add Gate</button>
        <button id="addDebugBtn">Add Debug</button>
        <button id="addSwitchBtn">Add Switch</button>

        <h2>Connect Nodes</h2>
        <div>
            <select id="fromNode"></select> →
            <select id="toNode"></select>
            <button id="addConnectionBtn">Add Connection</button>
        </div>

        <!-- Nodes Preview -->
        <h2>Nodes</h2>
        <ul id="nodesList"></ul>

        <!-- Connections Preview -->
        <h2>Connections</h2>
        <ul id="connectionsList"></ul>
    </div>

    <!-- ─── ACTION SECTION ───────────────────────── -->
    <h1>Then Do (Action)</h1>
    <div id="actionSection" style="margin-bottom:2em; border:1px solid #ccc; padding:1em;">
        <div class="trigger-grid">
            <div class="trigger-label">
                <label for="actionSelect"><b>Then do:</b></label>
            </div>
            <div class="trigger-input">
                <select id="actionSelect">
                    <option value="">-- select action --</option>
                    <option value="send_email">Send Email</option>
                </select>
            </div>
        </div>

        <!-- Email config appears only when Send Email is chosen -->
        <div id="emailConfig" style="display:none; margin-top:1em;">
            <div class="trigger-grid">
                <div class="trigger-label email-only"><label for="emailFrom"><b>Gmail address</b></label></div>
                <div class="trigger-input">
                    <input id="emailFrom" type="email" placeholder="you@gmail.com">
                </div>

                <div class="trigger-label email-only"><label for="emailPass"><b>Password / App password</b></label></div>
                <div class="trigger-input">
                    <input id="emailPass" type="password" placeholder="••••••••">
                </div>

                <div class="trigger-label email-only"><label for="emailTo"><b>To</b></label></div>
                <div class="trigger-input">
                    <input id="emailTo" type="text" placeholder="recipient@example.com">
                </div>
            </div>

            <div style="margin-top:1em;">
                <button id="saveEmailActionBtn">Add “Send Email” Action</button>
            </div>
        </div>
    </div>

    <!-- ─────────────────────────────────────────────────────── -->

    <!-- JSON Preview -->
    <h2>Flow JSON Preview</h2>
    <pre id="jsonPreview" style="background:#eee;padding:1em; height:300px; overflow:auto;"></pre>

    <!-- Clear options -->
    <button id="clearPreviewBtn">Clear JSON Preview</button>
    <button id="clearAllBtn">Clear All Nodes & Connections</button>

    <br><br><br>

    <!-- Send -->
    <button id="sendConfigBtn">Generate Flow</button>
    <p id="status"></p>

    <div id="configPanel"
        style="display:none; position:fixed; top:10%; left:10%; background:white; border:1px solid black; padding:1em; z-index:1000">
        <h3>Configure Gate Rules</h3>
        <p id="configLabel"></p>
        <div id="ruleForm"></div>
        <button id="addRuleRowBtn">Add Rule</button>
        <button id="saveConfigBtn">Save</button>
        <button id="closeConfigPanelBtn">Cancel</button>
    </div>

    <!-- Your custom script -->
    <script defer src="./index.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging.js";

        // Firebase config (must match your service account project)
        const firebaseConfig = {
            apiKey: "AIzaSyCZ2Kr_6gWKopc_QIabMb_QWGMmS9Cupzo",
            authDomain: "connect-to-node-red-74531.firebaseapp.com",
            projectId: "connect-to-node-red-74531",
            storageBucket: "connect-to-node-red-74531.appspot.com",
            messagingSenderId: "747008638747",
            appId: "1:747008638747:web:d0653f4b5601ee5a7d9dbe"
        };

        // Init Firebase
        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);

        // Register service worker in /test/
        const swReg = await navigator.serviceWorker.register('/test/firebase-messaging-sw.js');
        console.log('Service Worker registered', swReg);

        // Request permission
        const perm = await Notification.requestPermission();
        if (perm !== 'granted') {
            console.warn('Notifications not granted');
        } else {
            try {
                const token = await getToken(messaging, {
                    vapidKey: "BCn3SGnu-RLyeGqPWn3030CcKz0JNtcGrOgUwJJOSrx5eBA3osW0n49GECPYR6novHwxi50saQmcFNPTAYQuogw",
                    serviceWorkerRegistration: swReg
                });
                console.log('✅ FCM Token:', token);
                alert('Your FCM Token:\n' + token);
                // Optionally send to Node-RED via uibuilder
                // uibuilder.send({ fcmToken: token })
            } catch (err) {
                console.error('Error getting FCM token', err);
            }
        }

        // Foreground listener
        onMessage(messaging, payload => {
            console.log('[Foreground] Message received:', payload)
            const d = payload.data || {}
            const n = payload.notification || {}
            const title = d.title || n.title || 'Notification'
            const body  = d.body  || n.body  || ''
            const image  = d.icon  || n.icon  || n.image || 'https://kartinkof.club/uploads/posts/2022-03/1648356653_2-kartinkof-club-p-mem-im-fine-3.png'

            if (Notification.permission === 'granted') {
                new Notification(title, {
                    body, image,
                    // keeps the toast visible long enough to notice
                    requireInteraction: true,
                    // prevents deduplication if you’re testing fast
                    tag: String(Date.now()), renotify: true
                })
            }
        });
    </script>
</body>
</html>